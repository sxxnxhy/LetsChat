<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Chat List</title>
  <link rel="stylesheet" href="style.css">

  <script>

    document.addEventListener('DOMContentLoaded', () => {
      const chatListDiv = document.getElementById('chatList');

      fetch(`/api/chat-list/chats`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        }
      })
              .then(response => {
                if (!response.ok) {
                  throw new Error('Failed to fetch chats: ' + response.status);
                }
                return response.json();
              })
              .then(chats => {
                chatListDiv.innerHTML = chats.map(chat => {
                  // Format lastMessageTime
                  let timeDisplay = "No time available";
                  if (chat.lastMessageTime) {
                    const messageTime = new Date(chat.lastMessageTime);
                    const now = new Date();
                    const diffMs = now - messageTime;
                    const diffMin = Math.floor(diffMs / (1000 * 60));
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                    if (diffMin < 60) {
                      timeDisplay = diffMin <= 1 ? "1 min ago" : `${diffMin} min ago`;
                    } else if (diffHours < 24) {
                      timeDisplay = diffHours === 1 ? "1 hour ago" : `${diffHours} hours ago`;
                    } else if (diffDays <= 14) {
                      timeDisplay = diffDays === 1 ? "1 day ago" : `${diffDays} days ago`;
                    } else {
                      timeDisplay = messageTime.toLocaleDateString('en-CA'); // YYYY-MM-DD
                    }
                  }

                  return `
                        <p>
                            <a href="/chat-room.html?chatRoomId=${chat.chatRoomId}">
                                ${chat.chatRoomName}
                            </a>
                        </p>
                        <p>Last message: "${chat.lastMessage}" - (${timeDisplay})</p>
                        <hr>
                    `;
                }).join('');
              })
              .catch(error => {
                console.error('Error:', error);
                chatListDiv.innerHTML = '<p>Error loading chats. Please try again.</p>';
                setTimeout(() => window.location.href = '/login.html', 2000);
              });
    });

    function logout(event) {
      fetch('/api/user/logout', { method: 'POST' })
              .then(() => window.location.href = '/login.html');
    }

  </script>
</head>
<body>
<div class="container">
  <h2>Your Chats</h2>
  <hr>
  <div id="chatList">
    <!-- Chat items will be populated here -->
  </div>

  <a href="find-user.html">Find User</a> | <a href="login.html" onclick="logout()">Logout</a>
</div>
</body>
</html>