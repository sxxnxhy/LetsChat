<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Chat</title>
  <link rel="stylesheet" href="style.css">

    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const chatRoomId = urlParams.get('chatRoomId');
      const userId = localStorage.getItem('userId');
      let totalPages = 0;
      let isLoading = false;
      let currentPage = 0;

//WebSocket Connection
      const stompClient = new StompJs.Client({
        brokerURL: `wss://${window.location.hostname}/websocket`
        //brokerURL: `ws://${window.location.hostname}:8080/websocket`
      });
      stompClient.activate();

      //WebSocket subscription management.
      stompClient.onConnect = (frame) => {
        console.log('Connected: ' + frame);

        console.log("checking if the user is authenticated for this chat or not.")
        chatHistory(currentPage);

        // Load chat history
        function chatHistory(currentPage) {
          if (isLoading) return; // Prevent multiple simultaneous requests
          isLoading = true;

          // Show loading indicator for pages beyond the initial load
          const messagesDiv = document.getElementById('chatMessages');

          let loadingDiv = null;
          if (currentPage > 0) {
            loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.classList.add('loading');
            loadingDiv.textContent = 'Loading...';
            messagesDiv.insertBefore(loadingDiv, messagesDiv.firstChild);
          }

          fetch(`/api/chat-room/chat-history?chatRoomId=${chatRoomId}&page=${currentPage}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
              // 'Authorization': `Bearer ${token}` //헤더에 토큰 넣을 필요 없음. 쿠키에 저장되어있어서 api별로 필터가 걸리면 거기서 검증함.
            }
          })
                  .then(response => {
                    //채팅방에 해당 유저가 없음.
                    if (!response.ok) throw new Error('Failed to load chat history');
                    return response.json();
                  })
                  .then(data => {
                    totalPages = data.totalPages

                    document.getElementById('chatRecipient').textContent = data.chatRoomName;
                    const fragment = document.createDocumentFragment();

                    const messagesDiv = document.getElementById('chatMessages');
                    data.messages.forEach(msg => {
                      const messageDiv = document.createElement('div');
                      messageDiv.classList.add('message', msg.senderId == userId ? 'sent' : 'received');

                      // Only show sender name for received messages
                      if (msg.senderId != userId) {
                        const senderNameDiv = document.createElement('div');
                        senderNameDiv.classList.add('sender-name');
                        senderNameDiv.textContent = msg.senderName;
                        messageDiv.appendChild(senderNameDiv);
                      }

                      // Message content
                      const messageContentDiv = document.createElement('div');
                      messageContentDiv.classList.add('message-content');
                      messageContentDiv.textContent = msg.content;

                      //time
                      const messageTimeDiv = document.createElement('div');
                      messageTimeDiv.classList.add('message-time');
                      const date = new Date(msg.enrolledAt);
                      const hours = String(date.getHours()).padStart(2, '0');
                      const minutes = String(date.getMinutes()).padStart(2, '0');
                      const year = date.getFullYear();
                      const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
                      const day = String(date.getDate()).padStart(2, '0');
                      messageTimeDiv.textContent = `${year}-${month}-${day} / ${hours}:${minutes} `;

                      //appending them all to messageDiv
                      messageDiv.appendChild(messageContentDiv);
                      messageDiv.appendChild(messageTimeDiv);
                      fragment.appendChild(messageDiv);

                    });
                    // Remove loading indicator before appending messages
                    if (loadingDiv) {
                      messagesDiv.removeChild(loadingDiv);
                    }

                    // If it's the first page, append normally and scroll to bottom
                    if (currentPage === 0) {
                      messagesDiv.innerHTML = ''; // Clear existing messages
                      messagesDiv.appendChild(fragment);
                      scrollToBottom();
                    } else {
                      // For older pages, prepend to the top and maintain scroll position
                      const scrollHeightBefore = messagesDiv.scrollHeight;
                      messagesDiv.insertBefore(fragment, messagesDiv.firstChild);
                      messagesDiv.scrollTop = messagesDiv.scrollHeight - scrollHeightBefore;
                    }

                    // Subscribe to chat room only on initial load
                    if (currentPage === 0) {
                      console.log(`Subscribing to: /topic/private-chat/${chatRoomId}`);
                      subscribeToChatRoom();
                    }

                    isLoading = false;
                  })
                  .catch(error => {
                    // Remove loading indicator on error
                    if (loadingDiv) {
                      messagesDiv.removeChild(loadingDiv);
                    }
                    console.error('error loading history:', error);
                    console.log('user does not have access to this chat');
                    document.getElementById('chatMessages').innerHTML = '<p>Access denied</p>';
                    setTimeout(() => window.location.href = '/chat-list.html', 2000);
                    isLoading = false;
                  });
        }
        // Infinite scroll handler
        document.getElementById('chatMessages').addEventListener('scroll', function () {
          if (this.scrollTop === 0 && currentPage + 1 < totalPages && !isLoading) {
            currentPage++;
            chatHistory(currentPage);
          }
        });


        //해당 채팅방 구독 함수로 뺴놓기
        function subscribeToChatRoom() {
          // Subscribe using template literals (backticks)
          stompClient.subscribe(`/topic/private-chat/${chatRoomId}`, (message) => {
            const msgData = JSON.parse(message.body);
            console.log(msgData);
            const messagesDiv = document.getElementById('chatMessages');

            // Create message div
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', msgData.senderId == userId ? 'sent' : 'received');

            // Only show sender name for received messages
            if (msgData.senderId != userId) {
              const senderNameDiv = document.createElement('div');
              senderNameDiv.classList.add('sender-name');
              senderNameDiv.textContent = msgData.senderName;
              messageDiv.appendChild(senderNameDiv);
            }

            // Message content
            const messageContentDiv = document.createElement('div');
            messageContentDiv.classList.add('message-content');
            messageContentDiv.textContent = msgData.content;


            //time
            const messageTimeDiv = document.createElement('div');
            messageTimeDiv.classList.add('message-time');
            const date = new Date(msgData.enrolledAt);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
            const day = String(date.getDate()).padStart(2, '0');
            messageTimeDiv.textContent = `${year}-${month}-${day} / ${hours}:${minutes} `;


            messageDiv.appendChild(messageContentDiv);
            messageDiv.appendChild(messageTimeDiv);
            document.getElementById('chatMessages').appendChild(messageDiv);

            // Append and scroll
            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
          });
        }


        const messageInput = document.getElementById('messageInput');
        if (messageInput) {
          messageInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault(); // Prevents newline in input field
              sendMessage();
            }
          });
        }

        // Scroll to bottom of chat
        function scrollToBottom() {
          const messagesDiv = document.getElementById('chatMessages');
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        document.getElementById('sendButton').addEventListener('click', sendMessage);

        function sendMessage() {
          const input = document.getElementById('messageInput');
          const messageText = input.value.trim();

          if (messageText) {
            const urlParams = new URLSearchParams(window.location.search);
            const chatRoomId = urlParams.get('chatRoomId');
            const userId = localStorage.getItem('userId');
            stompClient.publish({
              destination: "/app/private-message",
              body: JSON.stringify({"chatRoomId": chatRoomId, "senderId": userId, "content": messageText})
            })

            input.value = '';

          }
        }


        let isActive = true;

        function setUserInactive() {
          if (!isActive) return;
          isActive = false;
          stompClient.publish({
            destination: "/app/user-inactive",
            body: JSON.stringify({"chatRoomId": chatRoomId, "userId": userId})
          });
        }

        function setUserActive() {
          if (isActive) return;
          isActive = true;
          stompClient.publish({
            destination: "/app/user-active",
            body: JSON.stringify({"chatRoomId": chatRoomId, "userId": userId})
          });
        }

        document.addEventListener("visibilitychange", function() {
          document.hidden ? setUserInactive() : setUserActive();
        });

        window.addEventListener("blur", setUserInactive);
        window.addEventListener("focus", setUserActive);
        window.addEventListener("beforeunload", setUserInactive); // Detects leaving page

      }});

  </script>


</head>
<body>
<div class="chat-container">
  <div class="chat-header">
    <h2><span id="chatRecipient"></span></h2>
    <a href="chat-list.html" style="color: black">Back to Chats</a>
  </div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input">
    <input type="text" id="messageInput" placeholder="Type a message..." maxlength="255">
    <button id="sendButton">Send</button>
  </div>
</div>
</body>
</html>